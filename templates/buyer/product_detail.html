{% extends "_base.html" %}
{% block title %}{{ p.name }}{% endblock %}

{% block content %}
  <div class="grid md:grid-cols-12 gap-6">

    <!-- Left: image -->
    <div class="md:col-span-6">
      {% if p.image %}
        <div class="bg-white border border-green-100 rounded-xl p-3 shadow-sm">
          <img
            src="{{ p.image.url }}"
            alt="{{ p.name }}"
            class="w-full h-[480px] object-cover rounded-lg"
          >
        </div>
      {% endif %}
    </div>

    <!-- Right: text content -->
    <div class="md:col-span-6">
      <h2 class="text-3xl font-bold mb-2">{{ p.name }}</h2>
      <p class="text-gray-700 mb-2">
        Price: <strong>${{ p.base_price }}</strong> / {{ p.unit|default:"kg" }}
      </p>
      <p class="text-gray-700 mb-4">
        Available: <strong>{{ p.stock }}</strong> {{ p.unit|default:"kg" }}
      </p>

      <!-- Purchase Link Button -->
      {% if p.purchase_link %}
        <a href="{{ p.purchase_link }}" target="_blank" rel="noopener noreferrer" class="inline-block px-5 py-2 mb-4 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition">
          Buy on external website
        </a>
      {% endif %}

      <h3 class="font-semibold mt-4">Description (Chinese)</h3>
      <p class="text-left leading-relaxed">
        {{ p.ai_description_zh|default:"Not generated yet" }}
      </p>

      <h3 class="font-semibold mt-4">Description (English)</h3>
      <p class="text-left leading-relaxed mt-2">
        {{ p.ai_description_en|default:"Not generated yet" }}
      </p>
    </div>

    <!-- Full-width: Pricing & Delivery -->
    <div class="md:col-span-12">
      <h3 class="font-semibold mt-2">Pricing & Delivery</h3>
      <div class="bg-white/80 border border-green-100 rounded-xl p-4">
        {% with ps=p.price_suggestions.last lg=p.logistics.last %}
          {% if ps or lg %}
            {% if ps %}
            <div class="flex flex-wrap items-end justify-between gap-3">
              <div>
                <div class="text-sm text-gray-500">Suggested Price</div>
                <div class="text-2xl font-semibold">
                  ${{ ps.suggested_price }}
                  <span class="text-base font-normal text-gray-500">/ {{ p.unit|default:"kg" }}</span>
                </div>
              </div>

              <div class="flex flex-wrap gap-2">
                <span class="px-2 py-0.5 text-xs rounded-full bg-green-50 text-green-700 border border-green-100">
                  Base ${{ p.base_price }}
                </span>
                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-50 text-gray-700 border border-gray-200">
                  Stock {{ p.stock }} {{ p.unit|default:"kg" }}
                </span>
                {% if p.category %}
                <span class="px-2 py-0.5 text-xs rounded-full bg-gray-50 text-gray-700 border border-gray-200">
                  {{ p.category }}
                </span>
                {% endif %}
              </div>
            </div>

            {% if ps.rationale %}
            <p class="mt-2 text-xs text-gray-500 leading-relaxed">
              {{ ps.rationale }}
            </p>
            {% endif %}
            {% endif %}

            {% if lg %}
            <div class="mt-3 text-sm">
              <div class="font-medium mb-1">Shipping Details</div>
              <ul class="list-disc list-inside text-gray-800 leading-relaxed">
                <li>Region: <strong>{{ lg.region }}</strong></li>
                <li>Carrier: <strong>{{ lg.carrier }}</strong></li>
                <li>Estimated Time: <strong>approx. {{ lg.estimated_days }} days</strong></li>
                <li>Cost: <strong>${{ lg.cost_estimate }}</strong></li>
              </ul>
            </div>
            {% endif %}
          {% else %}
            <p class="text-sm text-gray-500">No pricing or logistics suggestions available.</p>
          {% endif %}
        {% endwith %}
      </div>
    </div>

  </div>

  <hr class="my-6">

  <!-- Full-width: Ask Assistant -->
  <h3 class="text-xl font-semibold mb-2">Need Help? Ask Our Assistant</h3>
  <form method="post" class="space-y-3 bg-white p-4 rounded shadow">
    {% csrf_token %}

    <label class="block text-sm font-medium text-gray-700 mb-1" for="{{ form.question.id_for_label }}">
      Your question
    </label>

    <textarea
      id="{{ form.question.id_for_label }}"
      name="{{ form.question.html_name }}"
      rows="3"
      class="w-full rounded border border-gray-300 p-3 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
    >{{ form.question.value|default_if_none:'' }}</textarea>

    {% if form.question.errors %}
      <p class="text-red-600 text-sm mt-1">{{ form.question.errors.0 }}</p>
    {% endif %}

    <button class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition" type="submit">
      Submit
    </button>
  </form>

  {% if ai_answer %}
    <div class="mt-4 p-4 bg-gray-100 rounded">
      <div class="font-semibold mb-1">Assistant Answer:</div>
      <pre class="whitespace-pre-wrap">{{ ai_answer }}</pre>
    </div>
  {% endif %}

  <!-- Seller Contact Information -->
  {% if p.supplier %}
  <div class="mt-8 bg-white border border-green-100 rounded-xl p-5">
    <h3 class="font-semibold mb-3 text-green-700">Contact Information</h3>
    <div class="grid md:grid-cols-3 gap-4 text-gray-700">
      <p><strong>Name:</strong> {{ p.supplier.contact_name|default:"Not provided" }}</p>
      <p><strong>Email:</strong> {{ p.supplier.email|default:"Not provided" }}</p>
      <p><strong>Phone:</strong> {{ p.supplier.phone|default:"Not provided" }}</p>
    </div>
  </div>
  {% endif %}

{% endblock %}
